"use strict";(()=>{function U(s){return"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ".includes(s)}function T(s,e="Assertion failed."){if(!s)throw new Error(e)}var l=class s{type;value;constructor(e,n){this.type=e,this.value=n}eq(e){return this.type===e.type&&this.value===e.value}toString(){switch(this.type){case 4:return"%"+this.value;default:return this.value}}toNode(){return new ie(this)}static EMPTY=new s(0,"");static COMMAND_DISPLAYSTYLE=new s(2,"\\displaystyle");static COMMAND_TEXTSTYLE=new s(2,"\\textstyle")},M=class{type;head;constructor(e,n){this.type=e,this.head=n||l.EMPTY}eq(e){return this.type===e.type&&this.head.eq(e.head)}toString(){return this.serialize().reduce(le,"")}},ie=class extends M{constructor(e){super("terminal",e)}serialize(){switch(this.head.type){case 0:return[];case 1:case 2:case 3:case 4:case 7:return[this.head];case 5:case 6:{let e=[];for(let n of this.head.value){let t=n===" "?5:6;e.push(new l(t,n))}return e}default:throw new Error(`Unknown terminal token type: ${this.head.type}`)}}},_=class extends M{constructor(e){T(e.type===3),super("text",e)}serialize(){return[new l(2,"\\text"),new l(1,"{"),this.head,new l(1,"}")]}},y=class extends M{items;constructor(e){super("ordgroup",l.EMPTY),this.items=e}serialize(){return this.items.map(e=>e.serialize()).flat()}},S=class extends M{base;sup;sub;constructor(e){super("supsub",l.EMPTY),this.base=e.base,this.sup=e.sup,this.sub=e.sub}serialize(){let e=[],{base:n,sup:t,sub:r}=this;e=e.concat(n.serialize());function o(a){return a.type==="ordgroup"||a.type==="supsub"||a.head.type===0?!0:!!(a.head.type===1&&/\d+(\.\d+)?/.test(a.head.value)&&a.head.value.length>1)}return r&&(e.push(new l(7,"_")),o(r)?(e.push(new l(1,"{")),e=e.concat(r.serialize()),e.push(new l(1,"}"))):e=e.concat(r.serialize())),t&&(e.push(new l(7,"^")),o(t)?(e.push(new l(1,"{")),e=e.concat(t.serialize()),e.push(new l(1,"}"))):e=e.concat(t.serialize())),e}},w=class extends M{args;data;constructor(e,n,t=null){super("funcCall",e),this.args=n,this.data=t}serialize(){let e=[];e.push(this.head),this.head.value==="\\sqrt"&&this.data&&(e.push(new l(1,"[")),e=e.concat(this.data.serialize()),e.push(new l(1,"]")));for(let n of this.args)e.push(new l(1,"{")),e=e.concat(n.serialize()),e.push(new l(1,"}"));return e}},A=class extends M{body;left;right;constructor(e){super("leftright",l.EMPTY),this.body=e.body,this.left=e.left,this.right=e.right}serialize(){let e=[];return e.push(new l(2,"\\left")),e.push(new l(1,this.left?this.left.value:".")),e=e.concat(this.body.serialize()),e.push(new l(2,"\\right")),e.push(new l(1,this.right?this.right.value:".")),e}},q=class extends M{matrix;data;constructor(e,n,t=null){T(e.type===3),super("beginend",e),this.matrix=n,this.data=t}serialize(){let e=[],n=this.matrix;e.push(new l(2,"\\begin")),e.push(new l(1,"{")),e=e.concat(this.head),e.push(new l(1,"}")),e.push(new l(6,`
`));for(let t=0;t<n.length;t++){let r=n[t];for(let o=0;o<r.length;o++){let a=r[o];e=e.concat(a.serialize()),o!==r.length-1&&e.push(new l(7,"&"))}t!==n.length-1&&e.push(new l(7,"\\\\"))}return e.push(new l(6,`
`)),e.push(new l(2,"\\end")),e.push(new l(1,"{")),e=e.concat(this.head),e.push(new l(1,"}")),e}};function le(s,e){let n=e.toString(),t=!1;return e.type===5?t=!0:(t||=/[{\(\[\|]$/.test(s),t||=/\\\w+$/.test(s)&&n==="[",t||=/^[\.,;:!\?\(\)\]{}_^]$/.test(n),t||=["\\{","\\}"].includes(n),t||=n==="'",t||=s.endsWith("_")||s.endsWith("^"),t||=/\s$/.test(s),t||=/^\s/.test(n),t||=s==="",t||=/[\(\[{]\s*(-|\+)$/.test(s)||s==="-"||s==="+",t||=s.endsWith("&")&&n==="=",t||=/\d$/.test(s)&&/^[a-zA-Z]$/.test(n)),t||(s+=" "),s+n}function ue(s,e,n=0){let t=s.slice(n).findIndex(r=>r.eq(e));return t===-1?-1:t+n}function K(s,e){return s.some(n=>n.eq(e))}function C(s,e){let n=[],t=[];for(let r of s)r.eq(e)?(n.push(t),t=[]):t.push(r);return n.push(t),n}function ve(s,e){return s.flatMap((n,t)=>t!==s.length-1?[...n,e]:n)}function Le(s,e){return s.flatMap((n,t)=>t!==s.length-1?[n,e]:[n])}var Me={};function Ve(s,e){let n=s.reMatchArray[0].length,t=e.reMatchArray[0].length;return t!==n?t-n:s.index-e.index}var pe=class{_input;_lexer;_pos=0;_line=0;_col=0;_offset=0;_less=null;_go=!1;_newstate=null;_state;_text=null;_leng=null;_reMatchArray=null;constructor(e,n){this._input=e,this._lexer=n,this._state=n.states[0]}text(){return this._text}leng(){return this._leng}reMatchArray(){return this._reMatchArray}pos(){return this._pos}line(){return this._line}column(){return this._col}input(){return this._input.charAt(this._pos+this._leng+this._offset++)}unput(){return this._offset=this._offset>0?this._offset--:0}less(e){return this._less=e,this._offset=0,this._text=this._text.substring(0,e),this._leng=this._text.length}pushback(e){return this.less(this._leng-e)}reject(){this._go=!0}begin(e){if(this._lexer.specification[e])return this._newstate=e;let n=this._lexer.states[parseInt(e)];if(n)return this._newstate=n;throw"Unknown state '"+e+"' requested"}state(){return this._state}scan(){if(this._pos>=this._input.length)return Me;let e=this._input.substring(this._pos),n=this._lexer.specification[this._state],t=[];for(let c=0;c<n.length;c++){let h=n[c],d=e.match(h.re);d!==null&&d[0].length>0&&t.push({index:c,rule:h,reMatchArray:d})}if(t.length===0)throw new Error("No match found for input '"+e+"'");t.sort(Ve),this._go=!0;let r,o;for(let c=0,h=t.length;c<h&&this._go;c++){this._offset=0,this._less=null,this._go=!1,this._newstate=null;let d=t[c];if(o=d.reMatchArray[0],this._text=o,this._leng=o.length,this._reMatchArray=d.reMatchArray,r=d.rule.action(this),this._newstate&&this._newstate!=this._state){this._state=this._newstate;break}}let a=this._less===null?o:o.substring(0,this._less),u=a.length;this._pos+=u+this._offset;let p=a.match(/\n/g);return p!==null?(this._line+=p.length,this._col=u-a.lastIndexOf(`
`)-1):this._col+=u,r}},I=class{states;specification;constructor(e){this.states=Object.keys(e),this.specification={};for(let n of this.states){let t=e[n];if(n in this.specification)throw"Duplicate state declaration encountered for state '"+n+"'";this.specification[n]=[];for(let[r,o]of t.entries()){let a;try{a=new RegExp("^"+r)}catch(u){throw"Invalid regexp '"+r+"' in state '"+n+"' ("+u.message+")"}this.specification[n].push({re:a,action:o})}}}scanner(e){return new pe(e,this)}lex(e,n){let t=this.scanner(e);for(;;){let r=t.scan();if(r===Me)return;r!==void 0&&n(r)}}collect(e){let n=[],t=function(r){Array.isArray(r)?n.push(...r):n.push(r)};return this.lex(e,t),n}};var W=["sqrt","text","bar","bold","boldsymbol","ddot","dot","hat","mathbb","mathbf","mathcal","mathfrak","mathit","mathrm","mathscr","mathsf","mathtt","operatorname","operatorname*","overbrace","overline","pmb","rm","tilde","underbrace","underline","vec","widehat","widetilde","overleftarrow","overrightarrow","hspace","substack","displaylines","mathinner","mathrel","mathbin","mathop","not","bra","ket","braket","set","Bra","Ket","Braket","Set","pmod"],H=["frac","tfrac","binom","dbinom","dfrac","tbinom","overset","underset","textcolor"];function je(s){let e=["{","}","\\","$","&","#","_","%"];for(let n of e)s=s.replaceAll("\\"+n,n);return s}var Ke=new Map([[String.raw`\\begin{(array|subarry)}{(.+?)}`,s=>{let e=s.reMatchArray();return[new l(2,"\\begin"),new l(7,"{"),new l(3,e[1]),new l(7,"}"),new l(7,"{"),new l(3,e[2]),new l(7,"}")]}],[String.raw`\\(text|operatorname\*?|textcolor|begin|end|hspace|array){(.+?)}`,s=>{let e=s.reMatchArray();return[new l(2,"\\"+e[1]),new l(7,"{"),new l(3,je(e[2])),new l(7,"}")]}],[String.raw`%[^\n]*`,s=>new l(4,s.text().substring(1))],[String.raw`[{}_^&]`,s=>new l(7,s.text())],[String.raw`\\[\\,:;!> ]`,s=>new l(7,s.text())],[String.raw`~`,s=>new l(7,s.text())],[String.raw`\r?\n`,s=>new l(6,`
`)],[String.raw`\s+`,s=>new l(5,s.text())],[String.raw`\\[{}%$&#_|]`,s=>new l(1,s.text())],[String.raw`(\\[a-zA-Z]+)(\s*\d|\s+[a-zA-Z])\s*([0-9a-zA-Z])`,s=>{let e=s.reMatchArray(),n=e[1];if(H.includes(n.substring(1))){let t=e[2].trimStart(),r=e[3];return[new l(2,n),new l(1,t),new l(1,r)]}else return s.reject(),[]}],[String.raw`(\\[a-zA-Z]+)(\s*\d|\s+[a-zA-Z])`,s=>{let e=s.reMatchArray(),n=e[1];if(W.includes(n.substring(1))){let t=e[2].trimStart();return[new l(2,n),new l(1,t)]}else return s.reject(),[]}],[String.raw`\\[a-zA-Z]+`,s=>new l(2,s.text())],[String.raw`[0-9]+(\.[0-9]+)?`,s=>new l(1,s.text())],[String.raw`[a-zA-Z]`,s=>new l(1,s.text())],[String.raw`[+\-*/='<>!.,;:?()\[\]|]`,s=>new l(1,s.text())],[String.raw`[^\x00-\x7F]`,s=>new l(1,s.text())],[String.raw`.`,s=>new l(8,s.text())]]),Ze={start:Ke};function ce(s){return new I(Ze).collect(s)}var Qe=["bigl","bigr","bigm","biggl","biggr","biggm","Bigl","Bigr","Bigm","Biggl","Biggr","Biggm"],_e=l.EMPTY.toNode();function Je(s){return W.includes(s)?1:H.includes(s)?2:0}var Z=new l(7,"{"),G=new l(7,"}"),et=new l(1,"["),tt=new l(1,"]");function Q(s,e){let n=e;for(;n<s.length&&[5,6].includes(s[n].type);)n++;return s.slice(e,n)}function Oe(s,e){let n=s[e];return n.type===1&&["(",")","[","]","|","\\{","\\}",".","\\|","<",">"].includes(n.value)||n.type===2&&["lfloor","rfloor","lceil","rceil","langle","rangle","lparen","rparen","lbrace","rbrace"].includes(n.value.slice(1))?n:null}function F(s,e){let n=e;for(;n<s.length&&s[n].eq(new l(1,"'"));)n+=1;return n-e}function rt(s){let e=null,n=[],t=[],r=0;for(;;){if(r===s.length||s[r].head.eq(l.COMMAND_DISPLAYSTYLE)||s[r].head.eq(l.COMMAND_TEXTSTYLE)){if(n.length>0){let o=n.length===1?n[0]:new y(n);t.push(e?new w(e,[o]):o)}if(r===s.length)break;n=[],e=s[r].head}else n.push(s[r]);r++}return t}var Se=new l(2,"\\left"),Ae=new l(2,"\\right"),Re=new l(2,"\\begin"),Ce=new l(2,"\\end"),nt=new l(7,"\\\\"),g=class s extends Error{constructor(e){super(e),this.name="LatexParserError"}static UNMATCHED_LEFT_BRACE=new s("Unmatched '\\{'");static UNMATCHED_RIGHT_BRACE=new s("Unmatched '\\}'");static UNMATCHED_LEFT_BRACKET=new s("Unmatched '\\['");static UNMATCHED_RIGHT_BRACKET=new s("Unmatched '\\]'");static UNMATCHED_COMMAND_BEGIN=new s("Unmatched '\\begin'");static UNMATCHED_COMMAND_END=new s("Unmatched '\\end'");static UNMATCHED_COMMAND_LEFT=new s("Unmatched '\\left'");static UNMATCHED_COMMAND_RIGHT=new s("Unmatched '\\right'")},he=new l(7,"_"),de=new l(7,"^"),Te=class{space_sensitive;newline_sensitive;alignmentDepth=0;constructor(e=!1,n=!0){this.space_sensitive=e,this.newline_sensitive=n}parse(e){return this.parseGroup(e.slice(0))}parseGroup(e){let[n,t]=this.parseClosure(e,0,null);return n}parseClosure(e,n,t){let r=[],o=n;for(;o<e.length&&!(t!==null&&e[o].eq(t));){let[p,c]=this.parseNextExpr(e,o);o=c,!((p.head.type===5||p.head.type===6)&&(!this.space_sensitive&&p.head.value.replace(/ /g,"").length===0||!this.newline_sensitive&&p.head.value===`
`))&&r.push(p)}if(o>=e.length&&t!==null)return[_e,-1];let a=rt(r),u;return a.length===1?u=a[0]:u=new y(a),[u,o+1]}parseNextExpr(e,n){let[t,r]=this.parseNextExprWithoutSupSub(e,n),o=null,a=null,u=0;if(u+=F(e,r),r+=u,r<e.length){let p=e[r];if(p.eq(he)){[o,r]=this.parseNextExprWithoutSupSub(e,r+1);let c=F(e,r);if(u+=c,r+=c,r<e.length&&e[r].eq(de)&&([a,r]=this.parseNextExprWithoutSupSub(e,r+1),F(e,r)>0))throw new g("Double superscript")}else if(p.eq(de)){if([a,r]=this.parseNextExprWithoutSupSub(e,r+1),F(e,r)>0)throw new g("Double superscript");if(r<e.length&&e[r].eq(he)&&([o,r]=this.parseNextExprWithoutSupSub(e,r+1),F(e,r)>0))throw new g("Double superscript")}}if(o!==null||a!==null||u>0){let p={base:t,sup:null,sub:null};if(o&&(p.sub=o),u>0){let c=[];for(let h=0;h<u;h++)c.push(new l(1,"'").toNode());a&&c.push(a),p.sup=c.length===1?c[0]:new y(c)}else a&&(p.sup=a);return[new S(p),r]}else return[t,r]}parseNextExprWithoutSupSub(e,n){if(n>=e.length)throw new g("Unexpected end of input");let t=e[n];switch(t.type){case 1:case 3:case 4:case 5:case 6:return[t.toNode(),n+1];case 2:let r=t.value.slice(1);if(Qe.includes(r))return this.parseNextExprWithoutSupSub(e,n+1);if(t.eq(Re))return this.parseBeginEndExpr(e,n);if(t.eq(Ce))throw g.UNMATCHED_COMMAND_END;if(t.eq(Se))return this.parseLeftRightExpr(e,n);if(t.eq(Ae))throw g.UNMATCHED_COMMAND_RIGHT;return this.parseCommandExpr(e,n);case 7:switch(t.value){case"{":let[a,u]=this.parseClosure(e,n+1,G);if(u===-1)throw g.UNMATCHED_LEFT_BRACE;return[a,u];case"}":throw g.UNMATCHED_RIGHT_BRACE;case"\\\\":case"\\!":case"\\,":case"\\:":case"\\;":case"\\>":return[t.toNode(),n+1];case"\\ ":case"~":return[t.toNode(),n+1];case"_":case"^":return[_e,n];case"&":if(this.alignmentDepth<=0)throw new g("Unexpected & outside of an alignment");return[t.toNode(),n+1];default:throw new g("Unknown control sequence")}default:throw new g("Unknown token type")}}parseCommandExpr(e,n){T(e[n].type===2);let t=e[n],r=t.value,o=n+1;switch(Je(r.slice(1))){case 0:return[t.toNode(),o];case 1:{if(o>=e.length)throw new g("Expecting argument for "+r);if(r==="\\sqrt"&&o<e.length&&e[o].eq(et)){let[c,h]=this.parseClosure(e,o+1,tt);if(h===-1)throw g.UNMATCHED_LEFT_BRACKET;let[d,k]=this.parseNextArg(e,h);return[new w(t,[d],c),k]}else if(r==="\\text"){if(o+2>=e.length)throw new g("Expecting content for \\text command");T(e[o].eq(Z)),T(e[o+1].type===3),T(e[o+2].eq(G));let c=e[o+1];return[new _(c),o+3]}else if(r==="\\displaylines"){T(e[o].eq(Z));let[c,h]=this.parseAligned(e,o+1,G);if(h===-1)throw g.UNMATCHED_LEFT_BRACE;let d=new y(ve(c,nt.toNode()));return[new w(t,[d]),h]}let[u,p]=this.parseNextArg(e,o);return[new w(t,[u]),p]}case 2:{let[u,p]=this.parseNextArg(e,o),[c,h]=this.parseNextArg(e,p);return[new w(t,[u,c]),h]}default:throw new Error("Invalid number of parameters")}}parseNextArg(e,n){let t=n,r=null;for(;t<e.length;){let o;if([o,t]=this.parseNextExprWithoutSupSub(e,t),!(o.head.type===5||o.head.type===6)){r=o;break}}if(r===null)throw new g("Expecting argument but token stream ended");return[r,t]}parseLeftRightExpr(e,n){T(e[n].eq(Se));let t=n+1;if(t+=Q(e,t).length,t>=e.length)throw new g("Expecting a delimiter after \\left");let r=Oe(e,t);if(r===null)throw new g("Invalid delimiter after \\left");t++;let[o,a]=this.parseClosure(e,t,Ae);if(a===-1)throw g.UNMATCHED_COMMAND_LEFT;if(t=a,t+=Q(e,t).length,t>=e.length)throw new g("Expecting a delimiter after \\right");let u=Oe(e,t);if(u===null)throw new g("Invalid delimiter after \\right");t++;let p=r.value==="."?null:r,c=u.value==="."?null:u;return[new A({body:o,left:p,right:c}),t]}parseBeginEndExpr(e,n){T(e[n].eq(Re));let t=n+1;T(e[t].eq(Z)),T(e[t+1].type===3),T(e[t+2].eq(G));let r=e[t+1].value;t+=3;let o=null;["array","subarray"].includes(r)&&(t+=Q(e,t).length,[o,t]=this.parseNextArg(e,t));let[a,u]=this.parseAligned(e,t,Ce);if(u===-1)throw g.UNMATCHED_COMMAND_BEGIN;if(t=u,T(e[t].eq(Z)),T(e[t+1].type===3),T(e[t+2].eq(G)),e[t+1].value!==r)throw new g("\\begin and \\end environments mismatch");return t+=3,[new q(new l(3,r),a,o),t]}parseAligned(e,n,t){this.alignmentDepth++;let r=n;r+=Q(e,r).length;let o;if([o,r]=this.parseClosure(e,r,t),r===-1)return[[],-1];let a;if(o.type==="ordgroup"){let u=o.items;for(;u.length>0&&[5,6].includes(u[u.length-1].head.type);)u.pop();a=C(u,new l(7,"\\\\").toNode()).map(p=>C(p,new l(7,"&").toNode()).map(c=>new y(c)))}else a=[[o]];return this.alignmentDepth--,[a,r]}};function st(s){let e=t=>t.eq(he)||t.eq(de),n=[];for(let t=0;t<s.length;t++)s[t].type===5&&t+1<s.length&&e(s[t+1])||s[t].type===5&&t-1>=0&&e(s[t-1])||n.push(s[t]);return n}function ot(s,e){let n=[];for(let t of s)if(t.type===2&&e[t.value]){let r=ce(e[t.value]);n=n.concat(r)}else n.push(t);return n}function Ie(s,e={}){let n=new Te,t=ce(s);return t=st(t),t=ot(t,e),n.parse(t)}var $=new Map([["arrow.l.r.double.long","<==>"],["arrow.l.r.long","<-->"],["arrow.r.bar","|->"],["arrow.r.double.bar","|=>"],["arrow.r.double.long","==>"],["arrow.r.long","-->"],["arrow.r.long.squiggly","~~>"],["arrow.r.tail",">->"],["arrow.r.twohead","->>"],["arrow.l.double.long","<=="],["arrow.l.long","<--"],["arrow.l.long.squiggly","<~~"],["arrow.l.tail","<-<"],["arrow.l.twohead","<<-"],["arrow.l.r.double","<=>"],["colon.double.eq","::="],["dots.h","..."],["gt.triple",">>>"],["lt.triple","<<<"],["arrow.r","->"],["arrow.r.double","=>"],["arrow.r.squiggly","~>"],["arrow.l","<-"],["arrow.l.squiggly","<~"],["bar.v.double","||"],["bracket.l.stroked","[|"],["bracket.r.stroked","|]"],["colon.eq",":="],["eq.colon","=:"],["eq.not","!="],["gt.double",">>"],["gt.eq",">="],["lt.double","<<"],["lt.eq","<="],["ast.op","*"],["minus","-"],["tilde.op","~"],["arrow.l.r","<->"]]),J=new Map;for(let[s,e]of $.entries())e.length>1&&J.set(e,s);var i=class s{type;value;constructor(e,n){this.type=e,this.value=n}eq(e){return this.type===e.type&&this.value===e.value}isOneOf(e){return K(e,this)}toNode(){return new X(this)}toString(){switch(this.type){case 4:return`"${this.value}"`;case 5:return`//${this.value}`;default:return this.value}}static NONE=new s(0,"#none");static EMPTY=new s(2,"");static LEFT_BRACE=new s(2,"{");static RIGHT_BRACE=new s(2,"}");static LEFT_PAREN=new s(2,"(");static RIGHT_PAREN=new s(2,")");static LEFT_ANGLE=new s(1,"chevron.l");static RIGHT_ANGLE=new s(1,"chevron.r");static VERTICAL_BAR=new s(2,"|");static PLUS=new s(2,"+");static MINUS=new s(2,"-");static LR=new s(1,"lr");static LEFT_DELIMITERS=[s.LEFT_PAREN,new s(2,"["),s.LEFT_BRACE,s.VERTICAL_BAR,s.LEFT_ANGLE,new s(1,"paren.l"),new s(1,"brace.l")];static RIGHT_DELIMITERS=[s.RIGHT_PAREN,new s(2,"]"),s.RIGHT_BRACE,s.VERTICAL_BAR,s.RIGHT_ANGLE,new s(1,"paren.r"),new s(1,"brace.r")]},ge=class extends Error{node;constructor(e,n){super(e),this.name="TypstWriterError",this.node=n}},N=new i(7," "),v=class{type;head;options;constructor(e,n){this.type=e,this.head=n||i.NONE}setOptions(e){this.options=e}eq(e){return this.type===e.type&&this.head.eq(e.head)}toString(){throw new Error("Unimplemented toString() in base class TypstNode")}},X=class extends v{constructor(e){super("terminal",e)}isOverHigh(){return!1}isLeftSpaceful(){switch(this.head.type){case 6:case 8:return!1;case 4:return!0;case 1:case 2:return!["(","!",",",")","}","]"].includes(this.head.value);default:return!0}}isRightSpaceful(){switch(this.head.type){case 6:case 8:return!1;case 4:return!0;case 1:case 2:return["+","=",",","\\/","dot","dot.op","arrow","arrow.r"].includes(this.head.value);default:return!1}}toString(){return this.head.toString()}serialize(e,n){if(this.head.type===2){if(this.head.value===","&&e.insideFunctionDepth>0)return[N,new i(1,"comma")]}else if(this.head.type===1){let t=this.head.value;return n.preferShorthands&&$.has(t)&&(t=$.get(t)),n.inftyToOo&&t==="infinity"&&(t="oo"),[new i(1,t)]}else if(this.head.type===6||this.head.type===8){let t=[];for(let r of this.head.value)if(r===" ")n.keepSpaces&&t.push(new i(6,r));else if(r===`
`)t.push(new i(1,r));else throw new ge(`Unexpected whitespace character: ${r}`,this);return t}return[this.head]}},we=class{queue=[];pushSoftSpace(){if(this.queue.length!==0){{if(this.queue.at(-1).eq(N))return;if(["(","{","["].includes(this.queue.at(-1).value))return}this.queue.push(N)}}pushAll(e){if(e.length!=0)if(e[0].eq(N)&&this.queue.length===0)this.queue.push(...e.slice(1));else{if([")","}","]"].includes(e[0].value))for(;this.queue.at(-1)?.eq(N);)this.queue.pop();this.queue.push(...e)}}getQueue(){let e=Array.from(this.queue);for(;e.at(-1)?.eq(N);)e.pop();return e}},L=class extends v{items;constructor(e){super("group",i.NONE),this.items=e}isOverHigh(){return this.items.some(e=>e.isOverHigh())}isLeftSpaceful(){return this.items.length===0?!1:this.items[0].isLeftSpaceful()}isRightSpaceful(){return this.items.length===0?!1:this.items.at(-1).isRightSpaceful()}serialize(e,n){if(this.items.length===0)return[];let t=new we;for(let o=0;o<this.items.length;o++){let a=this.items[o],u=a.serialize(e,n);a.isLeftSpaceful()&&t.pushSoftSpace(),t.pushAll(u),a.isRightSpaceful()&&t.pushSoftSpace()}let r=t.getQueue();if(r.length>0&&(r[0].eq(i.MINUS)||r[0].eq(i.PLUS)))for(;r.length>1&&r[1].eq(N);)r.splice(1,1);return r}},O=class extends v{base;sup;sub;constructor(e){super("supsub",i.NONE),this.base=e.base,this.sup=e.sup,this.sub=e.sub}isOverHigh(){return this.base.isOverHigh()}isLeftSpaceful(){return!0}isRightSpaceful(){return!0}serialize(e,n){let t=[],{base:r,sup:o,sub:a}=this;t.push(...r.serialize(e,n));let u=o&&o.head.eq(new i(2,"'"));return u&&t.push(new i(2,"'")),a&&(t.push(new i(2,"_")),t.push(...a.serialize(e,n))),o&&!u&&(t.push(new i(2,"^")),t.push(...o.serialize(e,n))),t}},m=class extends v{args;constructor(e,n){super("funcCall",e),this.args=n}isOverHigh(){return this.head.value==="frac"?!0:this.args.some(e=>e.isOverHigh())}isLeftSpaceful(){return!0}isRightSpaceful(){return!["op","bold","dot"].includes(this.head.value)}serialize(e,n){let t=[],r=this.head;t.push(r),e.insideFunctionDepth++,t.push(ee);for(let o=0;o<this.args.length;o++)t.push(...this.args[o].serialize(e,n)),o<this.args.length-1&&(t.push(new i(2,",")),t.push(N));if(this.options)for(let[o,a]of Object.entries(this.options))t.push(new i(3,`, ${o}: ${a.toString()}`));return t.push(te),e.insideFunctionDepth--,t}},B=class extends v{args;constructor(e){super("fraction",i.NONE),this.args=e}isOverHigh(){return!0}isLeftSpaceful(){return!0}isRightSpaceful(){return!0}serialize(e,n){let t=[],[r,o]=this.args;return t.push(...r.serialize(e,n)),t.push(new i(2,"/")),t.push(...o.serialize(e,n)),t}},ee=new i(2,"("),te=new i(2,")"),f=class extends v{body;left;right;constructor(e,n){super("leftright",e),this.body=n.body,this.left=n.left,this.right=n.right}isOverHigh(){return this.body.isOverHigh()}isLeftSpaceful(){return!0}isRightSpaceful(){return!0}serialize(e,n){let t=[],r=new i(1,"lr"),{left:o,right:a}=this;return this.head.eq(r)&&(t.push(r),t.push(ee)),o&&(t.push(o),U(o.value[0])&&t.push(N)),t.push(...this.body.serialize(e,n)),a&&(U(a.value[0])&&t.push(N),t.push(a)),this.head.eq(r)&&t.push(te),t}},E=class s extends v{matrix;constructor(e,n){super("matrixLike",e),this.matrix=n}isOverHigh(){return!0}isLeftSpaceful(){return!0}isRightSpaceful(){return!1}serialize(e,n){let t=[],r,o;if(this.head.eq(s.MAT)?(r=new i(2,","),o=new i(2,";")):this.head.eq(s.CASES)?(r=new i(2,"&"),o=new i(2,",")):this.head.eq(i.NONE)&&(r=new i(2,"&"),o=new i(1,"\\")),!this.head.eq(i.NONE)&&(t.push(this.head),e.insideFunctionDepth++,t.push(ee),this.options))for(let[a,u]of Object.entries(this.options))t.push(new i(3,`${a}: ${u.toString()}, `));return this.matrix.forEach((a,u)=>{a.forEach((p,c)=>{t.push(...p.serialize(e,n)),c<a.length-1?(r.value==="&"&&t.push(N),t.push(r),t.push(N)):u<this.matrix.length-1&&(o.value==="\\"&&t.push(N),t.push(o),t.push(N))})}),this.head.eq(i.NONE)||(t.push(te),e.insideFunctionDepth--),t}static MAT=new i(1,"mat");static CASES=new i(1,"cases")},D=class extends v{fragments;constructor(e,n){super("markupFunc",e),this.fragments=n}isOverHigh(){return this.fragments.some(e=>e.isOverHigh())}isLeftSpaceful(){return!0}isRightSpaceful(){return!0}serialize(e,n){let t=[];if(t.push(this.head),e.insideFunctionDepth++,t.push(ee),this.options){let r=Object.entries(this.options);for(let o=0;o<r.length;o++){let[a,u]=r[o];t.push(new i(3,`${a}: ${u.toString()}`)),o<r.length-1&&t.push(new i(2,","))}}t.push(te),t.push(new i(3,"["));for(let r of this.fragments)t.push(new i(3,"$")),t.push(...r.serialize(e,n)),t.push(new i(3,"$"));return t.push(new i(3,"]")),t}};var Be=new i(1,`
`),be=new i(7," ");var re=class{buffer="";queue=[];options;constructor(e){this.options=e}serialize(e){let n={insideFunctionDepth:0};this.queue.push(...e.serialize(n,this.options))}flushQueue(){let e=this.queue.filter(r=>r.value!==""),n=[];for(let r of e)r.eq(be)&&n.length>0&&n[n.length-1].eq(be)||n.push(r);let t=new i(1,"");for(let r=0;r<n.length;r++)n[r].eq(be)&&(r===0||r===n.length-1||n[r-1].type===6||n[r-1].eq(Be)||n[r+1].eq(Be))&&(n[r]=t);for(let r of n)this.buffer+=r.toString();this.queue=[]}finalize(){this.flushQueue();let e=function(r){let o=r.replace(/floor\.l\s*(.*?)\s*floor\.r/g,"floor($1)");return o=o.replace(/floor\(\)/g,'floor("")'),o},n=function(r){let o=r.replace(/ceil\.l\s*(.*?)\s*ceil\.r/g,"ceil($1)");return o=o.replace(/ceil\(\)/g,'ceil("")'),o},t=function(r){let o=r.replace(/floor\.l\s*(.*?)\s*ceil\.r/g,"round($1)");return o=o.replace(/round\(\)/g,'round("")'),o};if(this.options.optimize){let r=[e,n,t];for(let o of r)this.buffer=o(this.buffer)}return this.buffer=this.buffer.replace(/& =/g,"&="),this.buffer}};var x=new Map([["displaystyle","display"],["textstyle","inline"],["hspace","#h"],["|","bar.v.double"],[",","thin"],[":","med"],[" ","med"],[";","thick"],[">","med"],["~","space.nobreak"],["blacktriangleleft","triangle.filled.l"],["blacktriangleright","triangle.filled.r"],["clubsuit","suit.club.filled"],["hookleftarrow","arrow.l.hook"],["hookrightarrow","arrow.r.hook"],["leftrightarrow","arrow.l.r"],["lgblksquare","square.filled.big"],["lgwhtsquare","square.stroked.big"],["nearrow","arrow.tr"],["nwarrow","arrow.tl"],["searrow","arrow.br"],["swarrow","arrow.bl"],["spadesuit","suit.spade.filled"],["updownarrow","arrow.t.b"],["ln","ln"],["log","log"],["cos","cos"],["sin","sin"],["tan","tan"],["cot","cot"],["sec","sec"],["csc","csc"],["mod","mod"],["omicron","omicron"],["Xi","Xi"],["Upsilon","Upsilon"],["lim","lim"],["binom","binom"],["tilde","tilde"],["hat","hat"],["sqrt","sqrt"],["bmod","mod"],["nonumber",""],["vec","arrow"],["neq","eq.not"],["dot","dot"],["ddot","dot.double"],["doteq","dot(eq)"],["dots","dots.h"],["vdots","dots.v"],["ddots","dots.down"],["widehat","hat"],["widetilde","tilde"],["quad","quad"],["qquad","wide"],["overbrace","overbrace"],["underbrace","underbrace"],["overline","overline"],["underline","underline"],["bar","macron"],["dbinom","binom"],["tbinom","binom"],["dfrac","frac"],["tfrac","frac"],["operatorname","op"],["operatorname*","op"],["boldsymbol","bold"],["mathbb","bb"],["mathbf","bold"],["mathcal","cal"],["mathscr","scr"],["mathit","italic"],["mathfrak","frak"],["mathrm","upright"],["mathsf","sans"],["mathtt","mono"],["rm","upright"],["pmb","bold"],["leadsto","arrow.r.squiggly"],["P","pilcrow"],["S","section"],["aleph","alef"],["infin","infinity"],["Delta","Delta"],["Gamma","Gamma"],["Lambda","Lambda"],["Omega","Omega"],["Phi","Phi"],["Pi","Pi"],["Psi","Psi"],["Sigma","Sigma"],["Theta","Theta"],["alpha","alpha"],["beta","beta"],["bigcirc","circle.big"],["bullet","bullet"],["cdot","dot.op"],["cdots","dots.c"],["checkmark","checkmark"],["chi","chi"],["circ","circle.small"],["colon","colon"],["cong","tilde.equiv"],["coprod","product.co"],["copyright","copyright"],["cup","union"],["curlyvee","or.curly"],["curlywedge","and.curly"],["dagger","dagger"],["dashv","tack.l"],["ddagger","dagger.double"],["delta","delta"],["ddots","dots.down"],["diamond","diamond"],["div","div"],["divideontimes","times.div"],["dotplus","plus.dot"],["ell","ell"],["emptyset","nothing"],["epsilon","epsilon.alt"],["equiv","equiv"],["eta","eta"],["exists","exists"],["forall","forall"],["gamma","gamma"],["ge","gt.eq"],["geq","gt.eq"],["geqslant","gt.eq.slant"],["gg","gt.double"],["hbar","planck"],["imath","dotless.i"],["iiiint","integral.quad"],["iiint","integral.triple"],["iint","integral.double"],["in","in"],["infty","infinity"],["int","integral"],["intercal","top"],["iota","iota"],["jmath","dotless.j"],["kappa","kappa"],["lambda","lambda"],["land","and"],["langle","chevron.l"],["lbrace","brace.l"],["lbrack","bracket.l"],["ldots","dots.h"],["le","lt.eq"],["leftthreetimes","times.three.l"],["leftrightarrow","arrow.l.r"],["leq","lt.eq"],["leqslant","lt.eq.slant"],["lhd","triangle.l"],["ll","lt.double"],["lor","or"],["ltimes","times.l"],["measuredangle","angle.arc"],["mid","divides"],["models","models"],["mp","minus.plus"],["mu","mu"],["nabla","nabla"],["ncong","tilde.equiv.not"],["ne","eq.not"],["neg","not"],["neq","eq.not"],["nexists","exists.not"],["ni","in.rev"],["nleftarrow","arrow.l.not"],["nleq","lt.eq.not"],["nparallel","parallel.not"],["ngeq","gt.eq.not"],["nmid","divides.not"],["notin","in.not"],["nsim","tilde.not"],["nsubseteq","subset.eq.not"],["nu","nu"],["ntriangleleft","lt.tri.not"],["ntriangleright","gt.tri.not"],["odot","dot.circle"],["oint","integral.cont"],["oiint","integral.surf"],["oiiint","integral.vol"],["omega","omega"],["ominus","minus.circle"],["otimes","times.circle"],["parallel","parallel"],["partial","partial"],["perp","perp"],["phi","phi.alt"],["pi","pi"],["pm","plus.minus"],["pounds","pound"],["prec","prec"],["preceq","prec.eq"],["prime","prime"],["prod","product"],["propto","prop"],["psi","psi"],["rangle","chevron.r"],["rbrace","brace.r"],["rbrack","bracket.r"],["rhd","triangle"],["rho","rho"],["rightarrow","arrow.r"],["rightthreetimes","times.three.r"],["rtimes","times.r"],["setminus","without"],["sigma","sigma"],["sim","tilde.op"],["simeq","tilde.eq"],["slash","slash"],["smallsetminus","without"],["spadesuit","suit.spade"],["sqsubseteq","subset.eq.sq"],["sqsupseteq","supset.eq.sq"],["subset","subset"],["subseteq","subset.eq"],["subsetneq","subset.neq"],["succ","succ"],["succeq","succ.eq"],["sum","sum"],["supset","supset"],["supseteq","supset.eq"],["supsetneq","supset.neq"],["tau","tau"],["theta","theta"],["times","times"],["to","arrow.r"],["top","top"],["triangle","triangle.t"],["twoheadrightarrow","arrow.r.twohead"],["upharpoonright","harpoon.tr"],["uplus","union.plus"],["upsilon","upsilon"],["varepsilon","epsilon"],["varnothing","diameter"],["varphi","phi"],["varpi","pi.alt"],["varrho","rho.alt"],["varsigma","sigma.alt"],["vartheta","theta.alt"],["vdash","tack.r"],["vdots","dots.v"],["vee","or"],["wedge","and"],["wr","wreath"],["xi","xi"],["yen","yen"],["zeta","zeta"],["intop","limits(integral)"],["LaTeX","#LaTeX"],["TeX","#TeX"]]),at=new Map([["acwopencirclearrow","arrow.ccw"],["adots","dots.up"],["angdnr","angle.acute"],["angle","angle"],["angles","angle.s"],["approx","approx"],["approxeq","approx.eq"],["approxident","tilde.triple"],["assert","tack.r.short"],["ast","ast.op"],["astrosun","sun"],["asymp","asymp"],["awint","integral.ccw"],["backcong","tilde.rev.equiv"],["backdprime","prime.double.rev"],["backprime","prime.rev"],["backsim","tilde.rev"],["backsimeq","tilde.eq.rev"],["backslash","backslash"],["backtrprime","prime.triple.rev"],["bardownharpoonleft","harpoon.bl.bar"],["bardownharpoonright","harpoon.br.bar"],["barleftarrow","arrow.l.stop"],["barleftarrowrightarrowbar","arrows.lr.stop"],["barleftharpoondown","harpoon.lb.stop"],["barleftharpoonup","harpoon.lt.stop"],["barrightharpoondown","harpoon.rb.bar"],["barrightharpoonup","harpoon.rt.bar"],["baruparrow","arrow.t.stop"],["barupharpoonleft","harpoon.tl.stop"],["barupharpoonright","harpoon.tr.stop"],["barV","tack.b.double"],["BbbA","AA"],["BbbB","BB"],["BbbC","CC"],["BbbD","DD"],["BbbE","EE"],["BbbF","FF"],["BbbG","GG"],["BbbH","HH"],["BbbI","II"],["BbbJ","JJ"],["BbbK","KK"],["BbbL","LL"],["BbbM","MM"],["BbbN","NN"],["BbbO","OO"],["BbbP","PP"],["BbbQ","QQ"],["BbbR","RR"],["BbbS","SS"],["BbbT","TT"],["BbbU","UU"],["BbbV","VV"],["BbbW","WW"],["BbbX","XX"],["BbbY","YY"],["BbbZ","ZZ"],["because","because"],["bigblacktriangledown","triangle.filled.b"],["bigblacktriangleup","triangle.filled.t"],["bigbot","tack.t.big"],["bigcap","inter.big"],["bigcup","union.big"],["bigcupdot","union.dot.big"],["biginterleave","interleave.big"],["bigodot","dot.o.big"],["bigoplus","plus.o.big"],["bigotimes","times.o.big"],["bigsqcap","inter.sq.big"],["bigsqcup","union.sq.big"],["bigstar","star.filled"],["bigtimes","times.big"],["bigtop","tack.b.big"],["bigtriangledown","triangle.stroked.b"],["bigtriangleup","triangle.stroked.t"],["biguplus","union.plus.big"],["bigvee","or.big"],["bigwedge","and.big"],["bigwhitestar","star.stroked"],["blackhourglass","hourglass.filled"],["blacktriangle","triangle.filled.small.t"],["blacktriangledown","triangle.filled.small.b"],["blkhorzoval","ellipse.filled.h"],["blkvertoval","ellipse.filled.v"],["bot","bot"],["boxast","ast.square"],["boxdot","dot.square"],["boxminus","minus.square"],["boxplus","plus.square"],["boxtimes","times.square"],["cap","inter"],["Cap","inter.double"],["capdot","inter.dot"],["capwedge","inter.and"],["caretinsert","caret"],["cdot","dot.op"],["cdotp","dot.c"],["checkmark","checkmark"],["circledast","ast.op.o"],["circledbullet","bullet.o"],["circledcirc","compose.o"],["circleddash","dash.o"],["circledequal","cc.nd"],["circledparallel","parallel.o"],["circledvert","bar.v.o"],["circledwhitebullet","bullet.stroked.o"],["Colon","colon.double"],["coloneq","colon.eq"],["Coloneq","colon.double.eq"],["complement","complement"],["cong","tilde.equiv"],["coprod","product.co"],["cup","union"],["Cup","union.double"],["cupdot","union.dot"],["cupleftarrow","union.arrow"],["cupvee","union.or"],["curlyeqprec","eq.prec"],["curlyeqsucc","eq.succ"],["curlyvee","or.curly"],["curlywedge","and.curly"],["curvearrowleft","arrow.ccw.half"],["curvearrowright","arrow.cw.half"],["cwopencirclearrow","arrow.cw"],["dagger","dagger"],["dashcolon","dash.colon"],["dashv","tack.l"],["Dashv","tack.l.double"],["dashVdash","tack.l.r"],["ddagger","dagger.double"],["ddddot","dot.quad"],["dddot","dot.triple"],["ddots","dots.down"],["DDownarrow","arrow.b.quad"],["Ddownarrow","arrow.b.triple"],["diameter","diameter"],["diamondcdot","diamond.stroked.dot"],["diamondsuit","suit.diamond.stroked"],["dicei","die.one"],["diceii","die.two"],["diceiii","die.three"],["diceiv","die.four"],["dicev","die.five"],["dicevi","die.six"],["div","div"],["divideontimes","times.div"],["Doteq","eq.dots"],["dotminus","minus.dot"],["dotplus","plus.dot"],["dotsim","tilde.dot"],["dottedcircle","circle.dotted"],["dottedsquare","square.stroked.dotted"],["doubleplus","plus.double"],["downarrow","arrow.b"],["Downarrow","arrow.b.double"],["downarrowbar","arrow.b.stop"],["downarrowbarred","arrow.b.struck"],["downdasharrow","arrow.b.dashed"],["downdownarrows","arrows.bb"],["downharpoonleft","harpoon.bl"],["downharpoonleftbar","harpoon.bl.stop"],["downharpoonright","harpoon.br"],["downharpoonrightbar","harpoon.br.stop"],["downharpoonsleftright","harpoons.blbr"],["downuparrows","arrows.bt"],["downupharpoonsleftright","harpoons.bltr"],["downwhitearrow","arrow.b.stroked"],["downzigzagarrow","arrow.zigzag"],["dprime","prime.double"],["dualmap","multimap.double"],["eighthnote","note.eighth.alt"],["ell","ell"],["emptysetoarr","emptyset.arrow.r"],["emptysetoarrl","emptyset.arrow.l"],["emptysetobar","emptyset.bar"],["emptysetocirc","emptyset.circle"],["eparsl","parallel.slanted.eq"],["eqcolon","eq.colon"],["eqdef","eq.def"],["eqgtr","eq.gt"],["eqless","eq.lt"],["eqsim","minus.tilde"],["equal","eq"],["equalparallel","parallel.eq"],["equiv","eq.triple"],["Equiv","eq.quad"],["equivVert","parallel.equiv"],["eqvparsl","parallel.slanted.equiv"],["errbarblackcircle","errorbar.circle.filled"],["errbarblackdiamond","errorbar.diamond.filled"],["errbarblacksquare","errorbar.square.filled"],["errbarcircle","errorbar.circle.stroked"],["errbardiamond","errorbar.diamond.stroked"],["errbarsquare","errorbar.square.stroked"],["euro","euro"],["exists","exists"],["fallingdotseq","eq.dots.down"],["fint","integral.slash"],["flat","flat"],["forall","forall"],["fourvdots","fence.dotted"],["frown","frown"],["fullouterjoin","join.l.r"],["geq","gt.eq"],["geqq","gt.equiv"],["geqslant","gt.eq.slant"],["gg","gt.double"],["ggg","gt.triple"],["gggnest","gt.triple.nested"],["gnapprox","gt.napprox"],["gneq","gt.neq"],["gneqq","gt.nequiv"],["gnsim","gt.ntilde"],["greater","gt"],["gtlpar","angle.spheric.rev"],["gtrapprox","gt.approx"],["gtrdot","gt.dot"],["gtreqless","gt.eq.lt"],["gtrless","gt.lt"],["gtrsim","gt.tilde"],["heartsuit","suit.heart.stroked"],["hknearrow","arrow.tr.hook"],["hknwarrow","arrow.tl.hook"],["hksearrow","arrow.br.hook"],["hkswarrow","arrow.bl.hook"],["horizbar","bar.h"],["hourglass","hourglass.stroked"],["hrectangle","rect.stroked.h"],["hrectangleblack","rect.filled.h"],["hyphenbullet","bullet.hyph"],["iiiint","integral.quad"],["iiint","integral.triple"],["iinfin","infinity.incomplete"],["iint","integral.double"],["Im","Im"],["imageof","image"],["in","in"],["increment","laplace"],["infty","infinity"],["int","integral"],["intbar","integral.dash"],["intBar","integral.dash.double"],["intcap","integral.inter"],["intclockwise","integral.cw"],["intcup","integral.union"],["interleave","interleave"],["intlarhk","integral.arrow.hook"],["intx","integral.times"],["inversebullet","bullet.hole"],["Join","join"],["langle","chevron.l"],["lAngle","chevron.l.double"],["langledot","chevron.l.dot"],["lat","lat"],["late","lat.eq"],["lbag","bag.l"],["lblkbrbrak","shell.l.filled"],["lbrace","brace.l"],["lBrace","brace.l.stroked"],["lbrack","bracket.l"],["lBrack","bracket.l.stroked"],["lbracklltick","bracket.l.tick.b"],["lbrackultick","bracket.l.tick.t"],["lbrbrak","shell.l"],["Lbrbrak","shell.l.stroked"],["lceil","ceil.l"],["lcurvyangle","chevron.l.curly"],["leftarrow","arrow.l"],["Leftarrow","arrow.l.double"],["leftarrowtail","arrow.l.tail"],["leftarrowtriangle","arrow.l.open"],["leftdasharrow","arrow.l.dashed"],["leftdotarrow","arrow.l.dotted"],["leftdowncurvedarrow","arrow.l.curve"],["leftharpoondown","harpoon.lb"],["leftharpoondownbar","harpoon.lb.bar"],["leftharpoonsupdown","harpoons.ltlb"],["leftharpoonup","harpoon.lt"],["leftharpoonupbar","harpoon.lt.bar"],["leftleftarrows","arrows.ll"],["leftouterjoin","join.l"],["Leftrightarrow","arrow.l.r.double"],["leftrightarrows","arrows.lr"],["leftrightarrowtriangle","arrow.l.r.open"],["leftrightharpoondowndown","harpoon.lb.rb"],["leftrightharpoondownup","harpoon.lb.rt"],["leftrightharpoons","harpoons.ltrb"],["leftrightharpoonsdown","harpoons.lbrb"],["leftrightharpoonsup","harpoons.ltrt"],["leftrightharpoonupdown","harpoon.lt.rb"],["leftrightharpoonupup","harpoon.lt.rt"],["leftrightsquigarrow","arrow.l.r.wave"],["leftsquigarrow","arrow.l.squiggly"],["leftthreearrows","arrows.lll"],["leftthreetimes","times.three.l"],["leftwavearrow","arrow.l.wave"],["leftwhitearrow","arrow.l.stroked"],["leq","lt.eq"],["leqq","lt.equiv"],["leqslant","lt.eq.slant"],["less","lt"],["lessapprox","lt.approx"],["lessdot","lt.dot"],["lesseqgtr","lt.eq.gt"],["lessgtr","lt.gt"],["lesssim","lt.tilde"],["lfloor","floor.l"],["lgblkcircle","circle.filled.big"],["lgroup","paren.l.flat"],["lgwhtcircle","circle.stroked.big"],["ll","lt.double"],["llangle","chevron.l.closed"],["llblacktriangle","triangle.filled.bl"],["llcorner","corner.l.b"],["LLeftarrow","arrow.l.quad"],["Lleftarrow","arrow.l.triple"],["lll","lt.triple"],["lllnest","lt.triple.nested"],["llparenthesis","paren.l.closed"],["lltriangle","triangle.stroked.bl"],["lmoustache","mustache.l"],["lnapprox","lt.napprox"],["lneq","lt.neq"],["lneqq","lt.nequiv"],["lnsim","lt.ntilde"],["longdashv","tack.l.long"],["Longleftarrow","arrow.l.double.long"],["longleftarrow","arrow.l.long"],["Longleftrightarrow","arrow.l.r.double.long"],["longleftrightarrow","arrow.l.r.long"],["longleftsquigarrow","arrow.l.long.squiggly"],["Longmapsfrom","arrow.l.double.long.bar"],["longmapsfrom","arrow.l.long.bar"],["longmapsto","arrow.r.long.bar"],["Longmapsto","arrow.r.double.long.bar"],["Longrightarrow","arrow.r.double.long"],["longrightarrow","arrow.r.long"],["longrightsquigarrow","arrow.r.long.squiggly"],["looparrowleft","arrow.l.loop"],["looparrowright","arrow.r.loop"],["lparen","paren.l"],["lParen","paren.l.stroked"],["lrblacktriangle","triangle.filled.br"],["lrcorner","corner.r.b"],["lrtriangle","triangle.stroked.br"],["ltimes","times.l"],["lvzigzag","fence.l"],["Lvzigzag","fence.l.double"],["maltese","maltese"],["mapsdown","arrow.b.bar"],["mapsfrom","arrow.l.bar"],["Mapsfrom","arrow.l.double.bar"],["mapsto","arrow.r.bar"],["Mapsto","arrow.r.double.bar"],["mapsup","arrow.t.bar"],["mathampersand","amp"],["mathatsign","at"],["mathcolon","colon"],["mathcomma","comma"],["mathdollar","dollar"],["mathexclam","excl"],["mathhyphen","hyph"],["mathparagraph","pilcrow"],["mathpercent","percent"],["mathperiod","dot.basic"],["mathplus","plus"],["mathquestion","quest"],["mathratio","ratio"],["mathsection","section"],["mathsemicolon","semi"],["mathslash","slash"],["mathsterling","pound"],["mathyen","yen"],["mdblkdiamond","diamond.filled.medium"],["mdblklozenge","lozenge.filled.medium"],["mdlgblkcircle","circle.filled"],["mdlgblkdiamond","diamond.filled"],["mdlgblklozenge","lozenge.filled"],["mdlgblksquare","square.filled"],["mdlgwhtcircle","circle.stroked"],["mdlgwhtdiamond","diamond.stroked"],["mdlgwhtlozenge","lozenge.stroked"],["mdlgwhtsquare","square.stroked"],["mdsmblkcircle","circle.filled.tiny"],["mdsmwhtcircle","circle.stroked.small"],["mdwhtdiamond","diamond.stroked.medium"],["mdwhtlozenge","lozenge.stroked.medium"],["measeq","eq.m"],["measuredangle","angle.arc"],["measuredangleleft","angle.arc.rev"],["measuredrightangle","angle.right.arc"],["mho","Omega.inv"],["mid","divides"],["minus","minus"],["models","models"],["mp","minus.plus"],["multimap","multimap"],["nabla","gradient"],["napprox","approx.not"],["nasymp","asymp.not"],["natural","natural"],["ncong","tilde.equiv.not"],["ne","eq.not"],["Nearrow","arrow.tr.double"],["neg","not"],["nequiv","equiv.not"],["neswarrow","arrow.tr.bl"],["nexists","exists.not"],["ngeq","gt.eq.not"],["ngtr","gt.not"],["ngtrless","gt.lt.not"],["ngtrsim","gt.tilde.not"],["nHdownarrow","arrow.b.dstruck"],["nhpar","parallel.struck"],["nHuparrow","arrow.t.dstruck"],["nhVvert","interleave.struck"],["ni","in.rev"],["nLeftarrow","arrow.l.double.not"],["nleftarrow","arrow.l.not"],["nLeftrightarrow","arrow.l.r.double.not"],["nleftrightarrow","arrow.l.r.not"],["nleq","lt.eq.not"],["nless","lt.not"],["nlessgtr","lt.gt.not"],["nlesssim","lt.tilde.not"],["nmid","divides.not"],["nni","in.rev.not"],["notin","in.not"],["nparallel","parallel.not"],["nprec","prec.not"],["npreccurlyeq","prec.curly.eq.not"],["nRightarrow","arrow.r.double.not"],["nrightarrow","arrow.r.not"],["nsim","tilde.not"],["nsimeq","tilde.eq.not"],["nsqsubseteq","subset.eq.sq.not"],["nsqsupseteq","supset.eq.sq.not"],["nsubset","subset.not"],["nsubseteq","subset.eq.not"],["nsucc","succ.not"],["nsucccurlyeq","succ.curly.eq.not"],["nsupset","supset.not"],["nsupseteq","supset.eq.not"],["ntrianglelefteq","lt.tri.eq.not"],["ntrianglerighteq","gt.tri.eq.not"],["nvartriangleleft","lt.tri.not"],["nvartriangleright","gt.tri.not"],["nVdash","forces.not"],["nvdash","tack.r.not"],["nvDash","tack.r.double.not"],["nvinfty","infinity.bar"],["nvLeftarrow","arrow.l.double.struck"],["nvleftarrow","arrow.l.struck"],["nVleftarrow","arrow.l.dstruck"],["nvleftarrowtail","arrow.l.tail.struck"],["nVleftarrowtail","arrow.l.tail.dstruck"],["nvLeftrightarrow","arrow.l.r.double.struck"],["nvleftrightarrow","arrow.l.r.struck"],["nVleftrightarrow","arrow.l.r.dstruck"],["nvRightarrow","arrow.r.double.struck"],["nvrightarrow","arrow.r.struck"],["nVrightarrow","arrow.r.dstruck"],["nvrightarrowtail","arrow.r.tail.struck"],["nVrightarrowtail","arrow.r.tail.dstruck"],["nvtwoheadleftarrow","arrow.l.twohead.struck"],["nVtwoheadleftarrow","arrow.l.twohead.dstruck"],["nvtwoheadleftarrowtail","arrow.l.twohead.tail.struck"],["nVtwoheadleftarrowtail","arrow.l.twohead.tail.dstruck"],["nvtwoheadrightarrow","arrow.r.twohead.struck"],["nVtwoheadrightarrow","arrow.r.twohead.dstruck"],["nvtwoheadrightarrowtail","arrow.r.twohead.tail.struck"],["nVtwoheadrightarrowtail","arrow.r.twohead.tail.dstruck"],["Nwarrow","arrow.tl.double"],["nwsearrow","arrow.tl.br"],["obrbrak","shell.t"],["obslash","backslash.o"],["odiv","div.o"],["odot","dot.o"],["odotslashdot","div.slanted.o"],["ogreaterthan","gt.o"],["oiiint","integral.vol"],["oiint","integral.surf"],["oint","integral.cont"],["ointctrclockwise","integral.cont.ccw"],["olessthan","lt.o"],["ominus","minus.o"],["operp","perp.o"],["oplus","plus.o"],["opluslhrim","plus.o.l"],["oplusrhrim","plus.o.r"],["origof","original"],["oslash","slash.o"],["otimes","times.o"],["otimeshat","times.o.hat"],["otimeslhrim","times.o.l"],["otimesrhrim","times.o.r"],["parallel","parallel"],["parallelogram","parallelogram.stroked"],["parallelogramblack","parallelogram.filled"],["parsim","parallel.tilde"],["partial","partial"],["pentagon","penta.stroked"],["pentagonblack","penta.filled"],["perp","perp"],["pm","plus.minus"],["prec","prec"],["Prec","prec.double"],["precapprox","prec.approx"],["preccurlyeq","prec.curly.eq"],["preceq","prec.eq"],["preceqq","prec.equiv"],["precnapprox","prec.napprox"],["precneq","prec.neq"],["precneqq","prec.nequiv"],["precnsim","prec.ntilde"],["precsim","prec.tilde"],["prime","prime"],["prod","product"],["propto","prop"],["QED","qed"],["qprime","prime.quad"],["quarternote","note.quarter.alt"],["questeq","eq.quest"],["Question","quest.double"],["rangle","chevron.r"],["rAngle","chevron.r.double"],["rangledot","chevron.r.dot"],["rangledownzigzagarrow","angle.azimuth"],["rbag","bag.r"],["rblkbrbrak","shell.r.filled"],["rbrace","brace.r"],["rBrace","brace.r.stroked"],["rbrack","bracket.r"],["rBrack","bracket.r.stroked"],["rbracklrtick","bracket.r.tick.b"],["rbrackurtick","bracket.r.tick.t"],["rbrbrak","shell.r"],["Rbrbrak","shell.r.stroked"],["rceil","ceil.r"],["rcurvyangle","chevron.r.curly"],["Re","Re"],["revangle","angle.rev"],["revemptyset","emptyset.rev"],["revnmid","divides.not.rev"],["rfloor","floor.r"],["rgroup","paren.r.flat"],["rightangle","angle.right"],["rightanglemdot","angle.right.dot"],["rightanglesqr","angle.right.square"],["rightarrow","arrow.r"],["Rightarrow","arrow.r.double"],["rightarrowbar","arrow.r.stop"],["rightarrowonoplus","plus.o.arrow"],["rightarrowtail","arrow.r.tail"],["rightarrowtriangle","arrow.r.open"],["rightdasharrow","arrow.r.dashed"],["rightdotarrow","arrow.r.dotted"],["rightdowncurvedarrow","arrow.r.curve"],["rightharpoondown","harpoon.rb"],["rightharpoondownbar","harpoon.rb.stop"],["rightharpoonsupdown","harpoons.rtrb"],["rightharpoonup","harpoon.rt"],["rightharpoonupbar","harpoon.rt.stop"],["rightleftarrows","arrows.rl"],["rightleftharpoons","harpoons.rtlb"],["rightleftharpoonsdown","harpoons.rblb"],["rightleftharpoonsup","harpoons.rtlt"],["rightouterjoin","join.r"],["rightrightarrows","arrows.rr"],["rightsquigarrow","arrow.r.squiggly"],["rightthreearrows","arrows.rrr"],["rightthreetimes","times.three.r"],["rightwavearrow","arrow.r.wave"],["rightwhitearrow","arrow.r.stroked"],["risingdotseq","eq.dots.up"],["rmoustache","mustache.r"],["rparen","paren.r"],["rParen","paren.r.stroked"],["rrangle","chevron.r.closed"],["RRightarrow","arrow.r.quad"],["Rrightarrow","arrow.r.triple"],["rrparenthesis","paren.r.closed"],["rsolbar","backslash.not"],["rtimes","times.r"],["rvzigzag","fence.r"],["Rvzigzag","fence.r.double"],["Searrow","arrow.br.double"],["setminus","without"],["sharp","sharp"],["shortdowntack","tack.b.short"],["shortlefttack","tack.l.short"],["shortuptack","tack.t.short"],["sim","tilde.op"],["sime","tilde.eq"],["similarleftarrow","arrow.l.tilde"],["similarrightarrow","arrow.r.tilde"],["simneqq","tilde.nequiv"],["smallblacktriangleleft","triangle.filled.small.l"],["smallblacktriangleright","triangle.filled.small.r"],["smallin","in.small"],["smallni","in.rev.small"],["smalltriangleleft","triangle.stroked.small.l"],["smalltriangleright","triangle.stroked.small.r"],["smashtimes","smash"],["smblkcircle","bullet"],["smblkdiamond","diamond.filled.small"],["smblklozenge","lozenge.filled.small"],["smeparsl","parallel.slanted.eq.tilde"],["smile","smile"],["smt","smt"],["smte","smt.eq"],["smwhtcircle","bullet.stroked"],["smwhtdiamond","diamond.stroked.small"],["smwhtlozenge","lozenge.stroked.small"],["sphericalangle","angle.spheric"],["sphericalangleup","angle.spheric.t"],["sqcap","inter.sq"],["Sqcap","inter.sq.double"],["sqcup","union.sq"],["Sqcup","union.sq.double"],["sqint","integral.square"],["sqsubset","subset.sq"],["sqsubseteq","subset.eq.sq"],["sqsubsetneq","subset.sq.neq"],["sqsupset","supset.sq"],["sqsupseteq","supset.eq.sq"],["sqsupsetneq","supset.sq.neq"],["squoval","square.stroked.rounded"],["sslash","slash.double"],["star","star.op"],["stareq","eq.star"],["subset","subset"],["Subset","subset.double"],["subsetdot","subset.dot"],["subseteq","subset.eq"],["subsetneq","subset.neq"],["succ","succ"],["Succ","succ.double"],["succapprox","succ.approx"],["succcurlyeq","succ.curly.eq"],["succeq","succ.eq"],["succeqq","succ.equiv"],["succnapprox","succ.napprox"],["succneq","succ.neq"],["succneqq","succ.nequiv"],["succnsim","succ.ntilde"],["succsim","succ.tilde"],["sum","sum"],["sumint","sum.integral"],["supset","supset"],["Supset","supset.double"],["supsetdot","supset.dot"],["supseteq","supset.eq"],["supsetneq","supset.neq"],["Swarrow","arrow.bl.double"],["therefore","therefore"],["threedangle","angle.spatial"],["threedotcolon","colon.tri.op"],["tieinfty","infinity.tie"],["times","times"],["tminus","miny"],["top","tack.b"],["tplus","tiny"],["trianglecdot","triangle.stroked.dot"],["triangledown","triangle.stroked.small.b"],["triangleleft","triangle.stroked.l"],["trianglelefteq","lt.tri.eq"],["triangleminus","minus.triangle"],["triangleplus","plus.triangle"],["triangleq","eq.delta"],["triangleright","triangle.stroked.r"],["trianglerighteq","gt.tri.eq"],["triangletimes","times.triangle"],["tripleplus","plus.triple"],["trprime","prime.triple"],["trslash","slash.triple"],["turnediota","iota.inv"],["twoheaddownarrow","arrow.b.twohead"],["twoheadleftarrow","arrow.l.twohead"],["twoheadleftarrowtail","arrow.l.twohead.tail"],["twoheadmapsfrom","arrow.l.twohead.bar"],["twoheadmapsto","arrow.r.twohead.bar"],["twoheadrightarrow","arrow.r.twohead"],["twoheadrightarrowtail","arrow.r.twohead.tail"],["twoheaduparrow","arrow.t.twohead"],["twonotes","note.eighth.beamed"],["ubrbrak","shell.b"],["ulblacktriangle","triangle.filled.tl"],["ulcorner","corner.l.t"],["ultriangle","triangle.stroked.tl"],["uminus","union.minus"],["underbrace","brace.b"],["underbracket","bracket.b"],["underparen","paren.b"],["unicodecdots","dots.h.c"],["unicodeellipsis","dots.h"],["upand","amp.inv"],["uparrow","arrow.t"],["Uparrow","arrow.t.double"],["uparrowbarred","arrow.t.struck"],["upbackepsilon","epsilon.alt.rev"],["updasharrow","arrow.t.dashed"],["upDigamma","Digamma"],["updigamma","digamma"],["Updownarrow","arrow.t.b.double"],["updownarrows","arrows.tb"],["updownharpoonleftleft","harpoon.tl.bl"],["updownharpoonleftright","harpoon.tl.br"],["updownharpoonrightleft","harpoon.tr.bl"],["updownharpoonrightright","harpoon.tr.br"],["updownharpoonsleftright","harpoons.tlbr"],["upharpoonleft","harpoon.tl"],["upharpoonleftbar","harpoon.tl.bar"],["upharpoonright","harpoon.tr"],["upharpoonrightbar","harpoon.tr.bar"],["upharpoonsleftright","harpoons.tltr"],["uplus","union.plus"],["upuparrows","arrows.tt"],["upwhitearrow","arrow.t.stroked"],["urblacktriangle","triangle.filled.tr"],["urcorner","corner.r.t"],["urtriangle","triangle.stroked.tr"],["UUparrow","arrow.t.quad"],["Uuparrow","arrow.t.triple"],["varclubsuit","suit.club.stroked"],["varhexagon","hexa.stroked"],["varhexagonblack","hexa.filled"],["varnothing","emptyset"],["varointclockwise","integral.cont.cw"],["varspadesuit","suit.spade.stroked"],["vartriangle","triangle.stroked.small.t"],["vartriangleleft","lt.tri"],["vartriangleright","gt.tri"],["Vbar","tack.t.double"],["Vdash","forces"],["vdash","tack.r"],["vDash","tack.r.double"],["vdots","dots.v"],["vee","or"],["Vee","or.double"],["veedot","or.dot"],["veeeq","eq.equi"],["vert","bar.v"],["Vert","bar.v.double"],["vlongdash","tack.r.long"],["vrectangle","rect.stroked.v"],["vrectangleblack","rect.filled.v"],["Vvert","bar.v.triple"],["vysmblkcircle","circle.filled.small"],["vysmwhtcircle","circle.stroked.tiny"],["wedge","and"],["Wedge","and.double"],["wedgedot","and.dot"],["wedgeq","eq.est"],["whiteinwhitetriangle","triangle.stroked.nested"],["whthorzoval","ellipse.stroked.h"],["whtvertoval","ellipse.stroked.v"],["wideangledown","angle.obtuse"],["wr","wreath"],["xsol","slash.big"]]),it=new Map([["gets","leftarrow"],["iff","Longleftrightarrow"],["implies","Longrightarrow"]]);for(let[s,e]of at)x.has(s)||x.set(s,e);var P=new Map;for(let[s,e]of Array.from(x.entries()).reverse())P.set(e,s);P.set("oo","infty");var lt=new Map([["top","top"],["frac","frac"],["tilde","tilde"],["hat","hat"],["upright","mathrm"],["bold","boldsymbol"],["infinity","infty"],["diff","partial"]]);for(let[s,e]of lt)P.set(s,e);for(let[s,e]of it)x.has(s)||x.set(s,x.get(e));var z=class extends Error{node;constructor(e,n=null){super(e),this.name="ConverterError",this.node=n}},ut=i.NONE.toNode(),pt=["dim","id","im","mod","Pr","sech","csch"];function ct(s){if(/^[a-zA-Z0-9]$/.test(s))return s;if(s==="/")return"\\/";if(["\\\\","\\{","\\}","\\%"].includes(s))return s.substring(1);if(["\\$","\\#","\\&","\\_"].includes(s))return s;if(s.startsWith("\\")){let e=s.slice(1);return x.has(e)?x.get(e):null}return s}function Y(s,e){let n;switch(s.type){case 0:return i.NONE;case 2:n=1;break;case 1:n=2;break;case 3:n=3;break;case 4:n=5;break;case 5:n=6;break;case 6:n=8;break;case 7:{if(s.value==="\\\\")return new i(7,"\\");if(s.value==="\\!")return new i(1,"#h(-math.thin.amount)");if(s.value==="~"){let r=x.get("~");return new i(1,r)}else if(x.has(s.value.substring(1))){let r=x.get(s.value.substring(1));return new i(1,r)}else throw new Error(`Unknown control sequence: ${s.value}`)}default:throw Error(`Unknown token type: ${s.type}`)}let t=ct(s.value);if(t===null){if(e.nonStrict)return new i(n,s.value.substring(1));throw new z(`Unknown token: ${s.value}`,s)}return new i(n,t)}function ht(s,e){let[n,t]=s.args;if(e.optimize&&["\\overset{\\text{def}}{=}","\\overset{d e f}{=}"].includes(s.toString()))return new i(1,"eq.def").toNode();let r=new m(new i(1,"limits"),[b(t,e)]);return new O({base:r,sup:b(n,e),sub:null})}function dt(s,e){let[n,t]=s.args,r=new m(new i(1,"limits"),[b(t,e)]);return new O({base:r,sub:b(n,e),sup:null})}function Tt(s){let e={},n={l:"#left",c:"#center",r:"#right"},t=Array.from(s),r=[],o=0;for(let u of t)u==="|"?r.push(o):(u==="l"||u==="c"||u==="r")&&o++;if(r.length>0){let u;r.length===1?u=`#${r[0]}`:u=`#(vline: (${r.join(", ")}))`,e.augment=new i(3,u).toNode()}let a=t.map(u=>n[u]).filter(u=>u!==void 0).map(u=>new i(3,u).toNode());if(a.length>0){let u=a.every(p=>p.eq(a[0]));e.align=u?a[0]:new i(3,"#center").toNode()}return e}var gt=new i(2,"("),wt=new i(2,")");function fe(s){return["group","supsub","matrixLike","fraction","empty"].includes(s.type)?new f(null,{left:gt,right:wt,body:s}):s}function b(s,e){switch(s.type){case"terminal":return Y(s.head,e).toNode();case"text":{let r=s;return new i(4,r.head.value).toNode()}case"ordgroup":let t=s;return new L(t.items.map(r=>b(r,e)));case"supsub":{let r=s,{base:o,sup:a,sub:u}=r;if(o&&o.type==="funcCall"&&o.head.value==="\\overbrace"&&a)return new m(new i(1,"overbrace"),[b(o.args[0],e),b(a,e)]);if(o&&o.type==="funcCall"&&o.head.value==="\\underbrace"&&u)return new m(new i(1,"underbrace"),[b(o.args[0],e),b(u,e)]);let p={base:b(o,e),sup:a?b(a,e):null,sub:u?b(u,e):null};return p.sup&&(p.sup=fe(p.sup)),p.sub&&(p.sub=fe(p.sub)),new O(p)}case"leftright":{let r=s,{left:o,right:a}=r,u=b(r.body,e);if(e.optimize&&o!==null&&a!==null){let d=Y(o,e),k=Y(a,e);if(o.value==="\\|"&&a.value==="\\|")return new m(new i(1,"norm"),[u]);if(["[]","()","\\{\\}","\\lfloor\\rfloor","\\lceil\\rceil","\\lfloor\\rceil"].includes(o.value+a.value))return new L([d.toNode(),u,k.toNode()])}let p=function(d){return["(",")","{","["].includes(d.value)?new i(2,"\\"+d.value):d},c=o?Y(o,e):null,h=a?Y(a,e):null;return c&&c.value==="<"&&(c=new i(1,"chevron.l")),h&&h.value===">"&&(h=new i(1,"chevron.r")),c===null&&h!==null&&(h=p(h)),h===null&&c!==null&&(c=p(c)),new f(i.LR,{body:u,left:c,right:h})}case"funcCall":{let r=s,o=b(r.args[0],e);if(r.head.value==="\\sqrt"&&r.data){let a=b(r.data,e);return new m(new i(1,"root"),[a,o])}if(r.head.value==="\\mathbf"){let a=new m(new i(1,"bold"),[o]);return new m(new i(1,"upright"),[a])}if(r.head.value==="\\overrightarrow")return new m(new i(1,"arrow"),[o]);if(r.head.value==="\\overleftarrow")return new m(new i(1,"accent"),[o,new i(1,"arrow.l").toNode()]);if(r.head.value==="\\operatorname"||r.head.value==="\\operatorname*"){if(e.optimize&&pt.includes(o.head.value))return new i(1,o.head.value).toNode();let a=new m(new i(1,"op"),[new i(4,o.head.value).toNode()]);return r.head.value==="\\operatorname*"&&a.setOptions({limits:new i(3,"#true").toNode()}),a}if(r.head.value==="\\textcolor"){let a=new D(new i(1,"#text"),[b(r.args[1],e)]);return a.setOptions({fill:o}),a}if(r.head.value==="\\substack"||r.head.value==="\\displaylines"||r.head.value==="\\mathinner")return o;if(r.head.value==="\\mathrel")return new m(new i(1,"class"),[new i(4,"relation").toNode(),o]);if(r.head.value==="\\mathbin")return new m(new i(1,"class"),[new i(4,"binary").toNode(),o]);if(r.head.value==="\\mathop")return new m(new i(1,"class"),[new i(4,"large").toNode(),o]);if(r.head.value==="\\not"){let a=b(r.args[0],e);if(T(a.type==="terminal"),a.head.type===1)return new i(1,a.head.value+".not").toNode();switch(a.head.value){case"=":return new i(1,"eq.not").toNode();default:throw new Error(`Not supported: \\not ${a.head.value}`)}}if(r.head.value==="\\pmod"){let a=new L([new i(1,"mod").toNode(),o]);return new f(null,{body:a,left:i.LEFT_PAREN,right:i.RIGHT_PAREN})}if(r.head.value==="\\overset")return ht(r,e);if(r.head.value==="\\underset")return dt(r,e);if(["\\bra","\\ket","\\braket","\\set","\\Bra","\\Ket","\\Braket","\\Set"].includes(r.head.value)){let a=function(u,p){let c=new m(new i(1,"mid"),[i.VERTICAL_BAR.toNode()]);if(u.type==="terminal"&&u.head.eq(i.VERTICAL_BAR))return c;if(u.type==="group"){let h=u;for(let d=0;d<h.items.length&&!(h.items[d].type==="terminal"&&h.items[d].head.eq(i.VERTICAL_BAR)&&(h.items[d]=c,p));d++);return h}else return u};var n=a;switch(r.head.value){case"\\bra":return new f(null,{body:o,left:i.LEFT_ANGLE,right:i.VERTICAL_BAR});case"\\ket":return new f(null,{body:o,left:i.VERTICAL_BAR,right:i.RIGHT_ANGLE});case"\\braket":return new f(null,{body:o,left:i.LEFT_ANGLE,right:i.RIGHT_ANGLE});case"\\set":return new f(null,{body:o,left:i.LEFT_BRACE,right:i.RIGHT_BRACE});case"\\Bra":return new f(i.LR,{body:o,left:i.LEFT_ANGLE,right:i.VERTICAL_BAR});case"\\Ket":return new f(i.LR,{body:o,left:i.VERTICAL_BAR,right:i.RIGHT_ANGLE});case"\\Braket":return new f(i.LR,{body:a(o,!1),left:i.LEFT_ANGLE,right:i.RIGHT_ANGLE});case"\\Set":return new f(i.LR,{body:a(o,!0),left:i.LEFT_BRACE,right:i.RIGHT_BRACE});default:}}if(r.head.value==="\\frac"&&e.fracToSlash)return new B(r.args.map(a=>b(a,e)).map(fe));if(e.optimize){if(r.head.value==="\\mathbb"&&/^\\mathbb{[A-Z]}$/.test(r.toString()))return new i(1,o.head.value.repeat(2)).toNode();if(r.head.value==="\\mathrm"&&r.toString()==="\\mathrm{d}")return new i(1,"dif").toNode()}return new m(Y(r.head,e),r.args.map(a=>b(a,e)))}case"beginend":{let r=s,o=r.matrix.map(a=>a.map(u=>b(u,e)));if(r.head.value.startsWith("align"))return new E(null,o);if(r.head.value==="cases")return new E(E.CASES,o);if(r.head.value==="subarray"){if(r.data)switch(r.data.head.value){case"r":o.forEach(u=>u.push(i.EMPTY.toNode()));break;case"l":o.forEach(u=>u.unshift(i.EMPTY.toNode()));break;default:break}return new E(null,o)}if(r.head.value==="array"){let a={delim:ut};T(r.data!==null&&r.head.type===3);let u=Tt(r.data.head.value);Object.assign(a,u);let p=new E(E.MAT,o);return p.setOptions(a),p}if(r.head.value.endsWith("matrix")){let a=new E(E.MAT,o),u;switch(r.head.value){case"matrix":u=i.NONE;break;case"pmatrix":return a;case"bmatrix":u=new i(4,"[");break;case"Bmatrix":u=new i(4,"{");break;case"vmatrix":u=new i(4,"|");break;case"Vmatrix":{u=new i(1,"bar.v.double");break}default:throw new z(`Unimplemented beginend: ${r.head}`,r)}return a.setOptions({delim:u.toNode()}),a}throw new z(`Unimplemented beginend: ${r.head}`,r)}default:throw new z(`Unimplemented node type: ${s.type}`,s)}}function R(s){switch(s.type){case 0:return l.EMPTY;case 1:{let e=function(n){switch(n){case"eq":return"=";case"plus":return"+";case"minus":return"-";case"percent":return"%";default:return P.has(n)?"\\"+P.get(n):"\\"+n}};if(s.value.endsWith(".not")){let n=e(s.value.slice(0,-4));return new l(2,n.startsWith("\\")?`\\not${n}`:`\\not ${n}`)}return new l(2,e(s.value))}case 2:{let e;return["{","}","%"].includes(s.value)?e="\\"+s.value:e=s.value,new l(1,e)}case 3:return new l(3,s.value);case 4:return new l(3,s.value);case 5:return new l(4,s.value);case 6:return new l(5,s.value);case 7:{let e;switch(s.value){case"\\":e="\\\\";break;case"&":e="&";break;default:throw new Error(`[typst_token_to_tex]Unimplemented control sequence: ${s.value}`)}return new l(7,e)}case 8:return new l(6,s.value);default:throw new Error(`Unimplemented token type: ${s.type}`)}}var bt=new l(1,",").toNode();function ye(s,e){let n=t=>ye(t,e);switch(s.type){case"terminal":{let t=s;if(t.head.type===1){if(t.head.value==="eq.def")return new w(new l(2,"\\overset"),[new _(new l(3,"def")),new l(1,"=").toNode()]);if(t.head.value==="comma")return new l(1,",").toNode();if(t.head.value==="dif")return new w(new l(2,"\\mathrm"),[new l(1,"d").toNode()]);if(t.head.value==="hyph"||t.head.value==="hyph.minus")return new _(new l(3,"-"));if(/^([A-Z])\1$/.test(t.head.value))return new w(new l(2,"\\mathbb"),[new l(1,t.head.value[0]).toNode()])}return t.head.type===4?new _(new l(3,t.head.value)):R(t.head).toNode()}case"group":{let r=s.items.map(n),o=new l(7,"&").toNode(),a=new l(7,"\\\\").toNode();if(K(r,o)){let u=C(r,a),p=[];for(let c of u){let h=C(c,o);p.push(h.map(d=>new y(d)))}return new q(new l(3,"aligned"),p)}return new y(r)}case"leftright":{let t=s,r=n(t.body),o=t.left?R(t.left):new l(1,"."),a=t.right?R(t.right):new l(1,".");return t.isOverHigh()&&(o.value="\\left"+o.value,a.value="\\right"+a.value),new y([o.toNode(),r,a.toNode()])}case"funcCall":{let t=s;switch(t.head.value){case"norm":{let r=t.args[0],o=n(r);return t.isOverHigh()?new A({body:o,left:new l(2,"\\|"),right:new l(2,"\\|")}):o}case"floor":case"ceil":{let r="\\l"+t.head.value,o="\\r"+t.head.value,a=t.args[0],u=n(a),p=new l(2,r),c=new l(2,o);return t.isOverHigh()?new A({body:u,left:p,right:c}):new y([p.toNode(),u,c.toNode()])}case"root":{let[r,o]=t.args,a=n(r);return new w(new l(2,"\\sqrt"),[n(o)],a)}case"overbrace":case"underbrace":{let[r,o]=t.args,a=new w(R(t.head),[n(r)]),u=n(o),p=t.head.value==="overbrace"?{base:a,sup:u,sub:null}:{base:a,sub:u,sup:null};return new S(p)}case"vec":{let r=t.args.map(o=>[n(o)]);return new q(new l(3,"pmatrix"),r)}case"op":{let r=t.args[0];return T(r.head.type===4),new w(R(t.head),[new l(3,r.head.value).toNode()])}case"class":{let r=t.args[0];T(r.head.type===4);let o;switch(r.head.value){case"relation":o="\\mathrel";break;case"binary":o="\\mathbin";break;case"large":o="\\mathop";break;default:throw new Error(`Unimplemented class: ${r.head.value}`)}return new w(new l(2,o),[n(t.args[1])])}case"display":{let r=t.args[0],o=new y([l.COMMAND_DISPLAYSTYLE.toNode(),n(r)]);return e.blockMathMode||o.items.push(l.COMMAND_TEXTSTYLE.toNode()),o}case"inline":{let r=t.args[0],o=new y([l.COMMAND_TEXTSTYLE.toNode(),n(r)]);return e.blockMathMode&&o.items.push(l.COMMAND_DISPLAYSTYLE.toNode()),o}default:{let r=R(t.head),o=W.includes(r.value.substring(1))||H.includes(r.value.substring(1));return r.value.length>0&&o?new w(r,t.args.map(n)):new y([R(t.head).toNode(),new l(1,"(").toNode(),...Le(t.args.map(n),bt),new l(1,")").toNode()])}}}case"markupFunc":{let t=s;switch(t.head.value){case"#text":if(t.options&&t.options.fill){let r=t.options.fill;return new w(new l(2,"\\textcolor"),[n(r),n(t.fragments[0])])}case"#heading":default:throw new Error(`Unimplemented markup function: ${t.head.value}`)}}case"supsub":{let t=s,{base:r,sup:o,sub:a}=t,u=o?n(o):null,p=a?n(a):null;if(r.head.eq(new i(1,"limits"))){let k=n(r.args[0]);if(u!==null&&p===null)return new w(new l(2,"\\overset"),[u,k]);if(u===null&&p!==null)return new w(new l(2,"\\underset"),[p,k]);{let ae=new w(new l(2,"\\underset"),[p,k]);return new w(new l(2,"\\overset"),[u,ae])}}let c=n(r);return new S({base:c,sup:u,sub:p})}case"matrixLike":{let t=s,r=t.matrix.map(o=>o.map(n));if(t.head.eq(E.MAT)){let o="pmatrix";if(t.options&&"delim"in t.options){let a=t.options.delim;switch(a.head.value){case"#none":o="matrix";break;case"[":case"]":o="bmatrix";break;case"(":case")":o="pmatrix";break;case"{":case"}":o="Bmatrix";break;case"|":o="vmatrix";break;case"bar":case"bar.v":o="vmatrix";break;case"bar.v.double":o="Vmatrix";break;default:throw new Error(`Unexpected delimiter ${a.head}`)}}return new q(new l(3,o),r)}else{if(t.head.eq(E.CASES))return new q(new l(3,"cases"),r);throw new Error(`Unexpected matrix type ${t.head}`)}}case"fraction":{let t=s,[r,o]=t.args,a=n(r),u=n(o);return new w(new l(2,"\\frac"),[a,u])}default:throw new Error("[convert_typst_node_to_tex] Unimplemented type: "+s.type)}}var mt=Array.from(J.keys());function ft(){return`(${mt.map(e=>(e=e.replaceAll("|","\\|"),e=e.replaceAll(".","\\."),e=e.replaceAll("[","\\["),e=e.replaceAll("]","\\]"),e)).join("|")})`}var yt=ft(),Et=new Map([[String.raw`//[^\n]*`,s=>new i(5,s.text().substring(2))],[String.raw`/`,s=>new i(2,s.text())],[String.raw`[_^&]`,s=>new i(7,s.text())],[String.raw`\r?\n`,s=>new i(8,`
`)],[String.raw`\s+`,s=>new i(6,s.text())],[String.raw`\\[$&#_]`,s=>new i(2,s.text())],[String.raw`\\\n`,s=>[new i(7,"\\"),new i(8,`
`)]],[String.raw`\\\s`,s=>[new i(7,"\\"),new i(6," ")]],[String.raw`\\\S`,s=>new i(7,"")],[String.raw`"([^"]|(\\"))*"`,s=>{let e=s.text().substring(1,s.text().length-1);return e.replaceAll('\\"','"'),new i(4,e)}],[yt,s=>{let e=s.text(),n=J.get(e);return new i(1,n)}],[String.raw`[0-9]+(\.[0-9]+)?`,s=>new i(2,s.text())],[String.raw`[+\-*/=\'<>!.,;?()\[\]|]`,s=>new i(2,s.text())],[String.raw`#h\((.+?)\)`,s=>{let e=s.reMatchArray();return[new i(1,"#h"),new i(2,"("),new i(3,e[1]),new i(2,")")]}],[String.raw`#none`,s=>new i(0,s.text())],[String.raw`#?[a-zA-Z\.]+`,s=>new i(s.text().length===1?2:1,s.text())],[String.raw`.`,s=>new i(2,s.text())]]),Nt={start:Et};function De(s){return new I(Nt).collect(s)}function Pe(s,e){let n=e;for(;n<s.length&&s[n].eq(new i(2,"'"));)n+=1;return n-e}function We(s,e,n,t){T(s[e].isOneOf(n));let r=1,o=e+1;for(;r>0;){if(o>=s.length)throw new Error("Unmatched brackets or parentheses");s[o].isOneOf(t)?r-=1:s[o].isOneOf(n)&&(r+=1),o+=1}return o-1}function Ee(s,e){return We(s,e,[V,He,qt],[ne,Ge,_t])}function xt(s){let e=new i(2,":").toNode(),n={},t=[];for(let r=0;r<s.length;r++){if(s[r].type!=="group")continue;let o=s[r],a=ue(o.items,e);if(a===-1||a===0)continue;if(t.push(r),o.items[a-1].eq(new i(1,"delim").toNode())){if(o.items.length!==3)throw new j("Invalid number of arguments for delim");n.delim=o.items[a+1]}else throw new j("Not implemented for other named parameters")}for(let r=t.length-1;r>=0;r--)s.splice(t[r],1);return[s,n]}function Ye(s){let e=[];for(let n=0;n<s;n++)e.push(new i(2,"'").toNode());return e}var se=new i(2,"/").toNode();function kt(s,e){let n=e;for(;n<s.length&&(s[n].head.type===6||s[n].head.type===8);)n++;return n===s.length?null:s[n]}function vt(s){let e=!1,n=[];for(let t=0;t<s.length;t++){let r=s[t];(r.head.type===6||r.head.type===8)&&(e||kt(s,t+1)?.eq(se))||(r.eq(se)?e=!0:e=!1,n.push(r))}return n}function Lt(s){s=vt(s);let e=[],n=[],t=0;for(;t<s.length;){let r=s[t];if(r.eq(se))e.push(r);else if(e.length>0&&e[e.length-1].eq(se)){let o=r;if(n.length===0)throw new j("Unexpected '/' operator, no numerator before it");let a=n.pop();o.type==="leftright"&&(o=o.body),a.type==="leftright"&&(a=a.body),n.push(new B([a,o])),e.pop()}else n.push(r);t++}return n.length===1?n[0]:new L(n)}function Mt(s){let e=new i(2,":").toNode(),n={};for(let t of s)T(t.items.length==3),T(t.items[1].eq(e)),n[t.items[0].toString()]=new X(new i(3,t.items[2].toString()));return n}var j=class extends Error{constructor(e){super(e),this.name="TypstParserError"}},ze=new i(7,"_"),Ue=new i(7,"^"),V=new i(2,"("),ne=new i(2,")"),He=new i(2,"["),Ge=new i(2,"]"),qt=new i(2,"{"),_t=new i(2,"}"),Ne=new i(2,","),Ot=new i(2,";"),St=new i(7,"&"),xe=class{space_sensitive;newline_sensitive;constructor(e=!0,n=!0){this.space_sensitive=e,this.newline_sensitive=n}parse(e){let[n,t]=this.parseGroup(e,0,e.length);return n}parseGroup(e,n,t){return this.parseUntil(e.slice(n,t),0,null)}parseNextExpr(e,n){let[t,r]=this.parseNextExprWithoutSupSub(e,n),o=null,a=null,u=Pe(e,r);if(u>0&&(t=new L([t].concat(Ye(u))),r+=u),r<e.length&&e[r].eq(ze)?([o,r]=this.parseSupOrSub(e,r+1),r<e.length&&e[r].eq(Ue)&&([a,r]=this.parseSupOrSub(e,r+1))):r<e.length&&e[r].eq(Ue)&&([a,r]=this.parseSupOrSub(e,r+1),r<e.length&&e[r].eq(ze)&&([o,r]=this.parseSupOrSub(e,r+1))),o!==null||a!==null){let p={base:t,sup:a,sub:o};return[new O(p),r]}else return[t,r]}parseUntil(e,n,t,r={}){r.spaceSensitive===void 0&&(r.spaceSensitive=this.space_sensitive),r.newlineSensitive===void 0&&(r.newlineSensitive=this.newline_sensitive);let o=[],a=n;for(;a<e.length&&!(t!==null&&e[a].eq(t));){let[p,c]=this.parseNextExpr(e,a);a=c,!((p.head.type===6||p.head.type===8)&&(!r.spaceSensitive&&p.head.value.replace(/ /g,"").length===0||!r.newlineSensitive&&p.head.value===`
`))&&o.push(p)}return a>=e.length&&t!==null?[i.NONE.toNode(),-1]:[Lt(o),a+1]}parseSupOrSub(e,n){let t,r;if(e[n].eq(V)){if([t,r]=this.parseUntil(e,n+1,ne),r===-1)throw new Error("Unmatched '('")}else[t,r]=this.parseNextExprWithoutSupSub(e,n);let o=Pe(e,r);return o>0&&(t=new L([t].concat(Ye(o))),r+=o),[t,r]}parseNextExprWithoutSupSub(e,n){let t=e[n],r=t.toNode();if(t.eq(V)){let[o,a]=this.parseUntil(e,n+1,ne);if(a===-1)throw new Error("Unmatched '('");return[new f(null,{body:o,left:V,right:ne}),a]}if(t.type===2&&!U(t.value[0]))return[r,n+1];if([2,1].includes(t.type)&&n+1<e.length&&e[n+1].eq(V)){if(t.value==="mat"){let[p,c,h]=this.parseMatrix(e,n+1,Ot,Ne),d=new E(t,p);return d.setOptions(c),[d,h]}if(t.value==="cases"){let[p,c,h]=this.parseMatrix(e,n+1,Ne,St),d=new E(t,p);return d.setOptions(c),[d,h]}if(t.value==="lr")return this.parseLrArguments(e,n+1);if(["#heading","#text"].includes(t.value)){let[p,c]=this.parseArguments(e,n+1),h=Mt(p);T(e[c].eq(He));let d=new i(2,"$"),k=We(e,c+1,[d],[d]),[ae,At]=this.parseGroup(e,c+2,k);T(e[k+1].eq(Ge));let ke=new D(t,[ae]);return ke.setOptions(h),[ke,k+2]}let[o,a]=this.parseArguments(e,n+1);return[new m(t,o),a]}return[r,n+1]}parseArguments(e,n){let t=Ee(e,n);return[this.parseArgumentsWithSeparator(e,n+1,t,Ne),t+1]}parseLrArguments(e,n){let t=new i(1,"lr"),r=Ee(e,n),o=null,a=null,u=n+1,p=r;p>u&&e[u].isOneOf(i.LEFT_DELIMITERS)&&(o=e[u],u+=1),p-1>u&&e[p-1].isOneOf(i.RIGHT_DELIMITERS)&&(a=e[p-1],p-=1);let[c,h]=this.parseGroup(e,u,p);return[new f(t,{body:c,left:o,right:a}),r+1]}parseMatrix(e,n,t,r){let o=Ee(e,n),a=[],u={},p=n+1;for(;p<o;)for(;p<o;){let c=ue(e,t,p);(c===-1||c>o)&&(c=o);let h=this.parseArgumentsWithSeparator(e,p,c,r),d={};[h,d]=xt(h),a.push(h),Object.assign(u,d),p=c+1}return[a,u,o+1]}parseArgumentsWithSeparator(e,n,t,r){let o=[],a=n;for(;a<t;){let u,p,c={spaceSensitive:!1,newlineSensitive:!0};[u,p]=this.parseUntil(e.slice(0,t),a,r,c),p==-1&&([u,p]=this.parseUntil(e.slice(0,t),a,null,c)),o.push(u),a=p}return o}};function Fe(s){let e=new xe,n=De(s);return e.parse(n)}var oe=class{buffer="";queue=[];append(e){this.queue=this.queue.concat(e.serialize())}flushQueue(){for(let e=0;e<this.queue.length;e++)this.buffer=le(this.buffer,this.queue[e]);this.queue=[]}finalize(){return this.flushQueue(),this.buffer=this.buffer.replace(/\\displaystyle \\displaystyle/g,"\\displaystyle"),this.buffer=this.buffer.replace(/\\textstyle \\textstyle/g,"\\textstyle"),this.buffer=this.buffer.replace(/\s?\\textstyle\s?$/,""),this.buffer=this.buffer.replace(/\s?\\displaystyle\s?$/,""),this.buffer}};function $e(s,e={}){let n={nonStrict:!0,preferShorthands:!0,keepSpaces:!1,fracToSlash:!0,inftyToOo:!1,optimize:!0,customTexMacros:{}};if(typeof e!="object")throw new Error("options must be an object");for(let a in n)a in e&&(n[a]=e[a]);let t=Ie(s,n.customTexMacros),r=b(t,n),o=new re(n);return o.serialize(r),o.finalize()}function Xe(s,e={}){let n={blockMathMode:!0};if(typeof e!="object")throw new Error("options must be an object");for(let a in n)a in e&&(n[a]=e[a]);let t=Fe(s),r=ye(t,n),o=new oe;return o.append(r),o.finalize()}window.tex2typst=$e;window.typst2tex=Xe;})();
